<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Meyvita - Hƒ±zlƒ± Sipari≈ü</title>
<style>
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:#fafafa;color:#222}
  header{background:#111;color:#fff;padding:14px 16px;text-align:center}
  header h1{margin:0;font-size:18px;letter-spacing:.3px}
  header .sub{font-size:12px;opacity:.85;margin-top:4px}
  main{max-width:760px;margin:16px auto;padding:0 12px 120px}
  .card{background:#fff;border-radius:12px;padding:14px;margin-bottom:12px;border:1px solid #eee}
  .row{display:grid;grid-template-columns:1.2fr 110px 96px;gap:8px;align-items:center}
  .row+.row{margin-top:8px}
  .row label{font-size:14px}
  .input,.row input,.row select{padding:10px 12px;border:1px solid #ddd;border-radius:10px;font-size:14px;width:100%}
  .two{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .btn{width:100%;padding:12px 14px;border:none;border-radius:10px;font-size:16px;cursor:pointer}
  .btn.primary{background:#111;color:#fff}
  .btn.print{background:#f1f1f1;color:#111;border:1px solid #ddd}
  .hint{font-size:12px;color:#666}
  .totals{font-size:14px;color:#444}
  footer{position:fixed;left:0;right:0;bottom:0;background:#fff;border-top:1px solid #eee;padding:10px 12px}
  .footer-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  @media print{
    header, main>.card:not(#receipt), footer{display:none!important}
    #receipt{display:block!important;border:none;padding:0}
    #ticket{width:80mm;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:12px;line-height:1.25;margin:0}
    #ticket h2,#ticket p{margin:0}
    #ticket .center{text-align:center}
    #ticket .line{border-top:1px dashed #000;margin:6px 0}
    #ticket table{width:100%;border-collapse:collapse}
    #ticket th,#ticket td{text-align:left;padding:2px 0}
    #ticket th.qty,#ticket td.qty,#ticket th.unit,#ticket td.unit{text-align:right}
  }
</style>
</head>
<body>
<header>
  <h1>Meyvita ‚Ä¢ Hƒ±zlƒ± Sipari≈ü</h1>
  <div class="sub">Etiler ‚Ä¢ Emirgan ‚Ä¢ Bebek ‚Äî 12:00'ye kadar verilen sipari≈üler aynƒ± g√ºn teslim.</div>
</header>

<main>
  <!-- Teslimat -->
  <div class="card">
    <div style="font-weight:700;margin-bottom:8px">Teslimat Bilgileri</div>
    <div class="two">
      <input id="name" class="input" placeholder="Ad Soyad">
      <input id="phone" class="input" placeholder="Telefon">
    </div>
    <div class="two" style="margin-top:8px">
      <input id="address" class="input" placeholder="Adres">
      <select id="zone" class="input">
        <option value="">B√∂lge se√ßin</option><option>Etiler</option><option>Emirgan</option><option>Bebek</option>
      </select>
    </div>
  </div>

  <!-- √úr√ºnler (Sheets'ten gelecek) -->
  <div class="card" id="products">
    <div style="font-weight:700;margin-bottom:8px">√úr√ºnler</div>
    <div id="list"><div class="hint">√úr√ºnler y√ºkleniyor‚Ä¶</div></div>
    <div class="hint" id="updated"></div>
  </div>

  <div class="card">
    <input id="note" class="input" placeholder="Not (√∂rn: 16:00 sonrasƒ± teslim)">
  </div>

  <!-- √ñzet + Fi≈ü -->
  <div id="receipt" class="card" style="display:none;">
    <div style="font-weight:700;margin-bottom:8px">Sipari≈ü √ñzeti</div>
    <div id="summary" class="totals"></div>
    <div id="ticket" style="display:none">
      <div class="center">
        <h2>Meyvita</h2>
        <p>Etiler ‚Ä¢ Emirgan ‚Ä¢ Bebek</p>
        <p>Tel: 0XXX XXX XX XX</p>
      </div>
      <div class="line"></div>
      <p id="t-meta"></p>
      <div class="line"></div>
      <table id="t-items">
        <thead><tr><th>√úr√ºn</th><th class="qty">Miktar</th><th class="unit">Birim</th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="line"></div>
      <p>Not: <span id="t-note">-</span></p>
      <p class="center">Te≈üekk√ºrler! üåø</p>
    </div>
  </div>
</main>

<footer>
  <div class="footer-grid">
    <button class="btn primary" id="build">Sipari≈üi Olu≈ütur</button>
    <button class="btn print" id="print" disabled>Fi≈üi Yazdƒ±r</button>
  </div>
</footer>

<script>
/* === YALNIZCA ≈ûU ID'Yƒ∞ DEƒûƒ∞≈ûTƒ∞RME: Senin Sheet ID'in bu === */
const SHEET_ID = "1oFofVAu7DIE5RIQu8PnDw9hIDBl25Bxe7oMQjVLYD8g";
/* =========================================================== */

/* Google Sheets'ten JSON veri √ßek (gviz) ‚Äî CSV'den daha saƒülam */
const GVIZ_URL = https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json;

/* Ba≈ülƒ±klarƒ± normalle: k√º√ß√ºk harfe √ßevir, T√ºrk√ße karakterleri sadele≈ütir */
function norm(s){
  return (s||"").toString().toLowerCase()
    .replaceAll("√º","u").replaceAll("ƒü","g").replaceAll("≈ü","s")
    .replaceAll("ƒ±","i").replaceAll("√∂","o").replaceAll("√ß","c")
    .replace(/[^\w]+/g,"").trim();
}

function money(n){ return new Intl.NumberFormat('tr-TR',{style:'currency',currency:'TRY',maximumFractionDigits:0}).format(n||0); }

async function loadProducts(){
  try{
    const res = await fetch(GVIZ_URL, {cache:"no-store"});
    const text = await res.text();
    const json = JSON.parse(text.substring(text.indexOf("{"), text.lastIndexOf("}")+1));
    const table = json.table;

    // Ba≈ülƒ±k haritalama
    const headers = table.cols.map(c => norm(c.label));
    // Beklenen: urun, birim, fiyat, kategori, aktif (sƒ±ra fark etmez)
    const ix = {
      urun: headers.indexOf("urun") !== -1 ? headers.indexOf("urun") : headers.indexOf("urunadi") ,
      birim: headers.indexOf("birim"),
      fiyat: headers.indexOf("fiyat"),
      kategori: headers.indexOf("kategori"),
      aktif: headers.indexOf("aktif")
    };

    const rows = table.rows || [];
    const products = [];

    rows.forEach(r=>{
      const cells = r.c || [];
      const val = i => (cells[i] && (cells[i].v ?? cells[i].f ?? "") ) || "";
      const p = {
        urun: String(val(ix.urun)).trim(),
        birim: String(val(ix.birim)).trim(),
        fiyat: parseFloat(String(val(ix.fiyat)).replace(",", ".")) || 0,
        kategori: String(val(ix.kategori)||"Genel").trim(),
        aktif: String(val(ix.aktif)||"").toLowerCase().includes("evet")
      };
      if(p.urun && p.aktif) products.push(p);
    });

    // Kategoriye g√∂re gruplama
    const byCat = {};
    products.forEach(p=>{
      const k = p.kategori || "Genel";
      (byCat[k] = byCat[k] || []).push(p);
    });

    const list = document.getElementById("list");
    list.innerHTML = "";
    Object.keys(byCat).forEach(cat=>{
      const h = document.createElement("div");
      h.style.cssText = "font-weight:700;margin:6px 0 8px";
      h.textContent = cat;
      list.appendChild(h);

      byCat[cat].forEach(p=>{
        const row = document.createElement("div");
        row.className = "row";
        row.innerHTML = `
          <label>${p.urun} (${money(p.fiyat)}/${p.birim||"-"})</label>
          <input type="number" min="0" step="0.5" placeholder="${p.birim||''}" class="qty"
                 data-item="${p.urun}" data-price="${p.fiyat}" data-unit="${p.birim||''}">
          <div style="text-align:right;color:#555">${p.birim||""}</div>
        `;
        list.appendChild(row);
      });
    });

    const now = new Date();
    document.getElementById("updated").textContent = "Liste g√ºncellendi: " + now.toLocaleString("tr-TR");
  }catch(e){
    console.error(e);
    document.getElementById("list").innerHTML =
      '<div class="hint" style="color:#b00">√úr√ºnler y√ºklenemedi. Sheets payla≈üƒ±mƒ± "Baƒülantƒ±ya sahip olan herkes ‚Üí G√∂r√ºnt√ºleyebilir" olmalƒ±.</div>';
  }
}

let lastOrder = null;

function buildOrder(){
  const name=document.getElementById('name').value.trim();
  const phone=document.getElementById('phone').value.trim();
  const address=document.getElementById('address').value.trim();
  const zone=document.getElementById('zone').value.trim();
  const note=document.getElementById('note').value.trim();

  const qtys=[...document.querySelectorAll('.qty')];
  const items=[];
  qtys.forEach(input=>{
    const v=parseFloat(input.value);
    if(!isNaN(v) && v>0){
      const price=parseFloat(input.dataset.price||'0');
      const unit=input.dataset.unit||'';
      const name=input.dataset.item||'';
      items.push({name, qty:v, unit, price, subtotal: price*v});
    }
  });

  if(items.length===0){ alert('En az bir √ºr√ºn miktarƒ± giriniz.'); return; }

  const total=items.reduce((s,i)=>s+i.subtotal,0);
  lastOrder={ name, phone, address, zone, note, items, total };

  const sum=document.getElementById('summary');
  sum.innerHTML = `
    <div><b>${name||'-'}</b> ‚Ä¢ ${phone||'-'} ‚Ä¢ ${zone||'-'}<br>${address||'-'}</div>
    <div style="margin-top:8px">${items.map(i=>‚Ä¢ ${i.name}: <b>${i.qty}</b> ${i.unit} ‚Äî ${money(i.subtotal)}).join('<br>')}</div>
    <div style="margin-top:8px;font-weight:700">Toplam: ${money(total)}</div>
  `;

  // Fi≈ü
  document.getElementById('t-meta').textContent =
    M√º≈üteri: ${name||'-'}  Tel: ${phone||'-'}  B√∂lge: ${zone||'-'}  Adres: ${address||'-'};
  const tbody=document.querySelector('#t-items tbody');
  tbody.innerHTML = items.map(i=><tr><td>${i.name}</td><td class="qty">${i.qty}</td><td class="unit">${i.unit}</td></tr>).join('');
  document.getElementById('t-note').textContent = note || '-';

  document.getElementById('receipt').style.display='block';
  document.getElementById('ticket').style.display='block';
  document.getElementById('print').disabled=false;
  window.scrollTo({top:document.getElementById('receipt').offsetTop-12,behavior:'smooth'});
}

function printTicket(){ window.print(); }

document.getElementById('build').addEventListener('click', buildOrder);
document.getElementById('print').addEventListener('click', printTicket);
window.addEventListener('load', loadProducts);
</script>
</body>
</html>
